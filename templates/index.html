<!DOCTYPE html>
<html>
<head>
    <title>二次方程式とは?</title>
</head>
<body>
    <h1>supermochiBBS</h1>
    <h2>supermochiBBSへようこそ</h2>
        <form id="postForm">
        <div>
            <label for="name">名前：</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div>
            <label for="password">パスワード：</label>
            <input type="password" id="password" name="password" required>
        </div>
        <div>
            <label for="text">投稿内容：</label>
            <textarea id="text" name="text" rows="4" cols="50" required maxlength="140"></textarea>
        </div>
        <button type="submit">投稿</button>
        <div id="post-error" style="color: red;"></div>
    </form>
    <hr>
    <h2>投稿一覧</h2>
    <ul id="post-list">
        {% for post in posts %}
        <li data-post-id="{{ post.id }}">
            ID: {{ post.id }} (パスワードID: {{ post.password_id }}) -
            {{ post.created_at }} -
            <strong>{{ post.name }}</strong>:
            {{ post.text }}
        </li>
        {% endfor %}
    </ul>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const postForm = document.getElementById('postForm');
            const postList = document.getElementById('post-list');
            const postError = document.getElementById('post-error');

            postForm.addEventListener('submit', function(event) {
                event.preventDefault(); // デフォルトのフォーム送信を阻止

                const formData = new FormData(postForm);

                fetch('/post_async', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        postError.textContent = data.error;
                    } else {
                        postError.textContent = '';
                        postForm.reset(); // フォームをリセット
                        // 新しい投稿を投稿一覧の先頭に追加
                        const newPost = data.post;
                        const newLi = document.createElement('li');
                        newLi.dataset.postId = newPost.id;
                        newLi.innerHTML = `
                            ID: ${newPost.id} (パスワードID: ${newPost.password_id}) -
                            ${newPost.created_at} -
                            <strong>${newPost.name}</strong>:
                            ${newPost.text}
                        `;
                        postList.insertBefore(newLi, postList.firstChild);
                    }
                })
                .catch(error => {
                    console.error('投稿エラー:', error);
                    postError.textContent = '投稿に失敗しました。';
                });
            });
        });
    </script>
</body>
</html>
